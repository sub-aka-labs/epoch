"use strict";var e=require("react/jsx-runtime"),r=require("react"),t=require("./ModalHeader-C5O9gNUP.js"),o=require("./ScreenHeader-CgYJ5Fmg.js"),a=require("./context-BeSQM-Ma.js"),i=require("./index-CzmnSRoa.js"),n=require("./internal-context-BJv4f_bO.js"),l=require("./get-is-unified-wallet-BwdzQwn_.js"),c=require("./paths-DizMb-lU.js"),s=require("./useWallets-DMyuB5aJ.js"),d=require("./events-context-Di6--rDg.js"),u=require("./styles-CQnB5gHS.js");async function v({url:e,popup:r,provider:t}){return r.location=e,new Promise(((e,t)=>{function o(){r?.close(),window.removeEventListener("message",a)}function a(r){r.data&&("PRIVY_OAUTH_RESPONSE"===r.data.type&&r.data.stateCode&&r.data.authorizationCode&&(e(r.data),o()),"https://cdn.apple-cloudkit.com"===r.origin&&r.data.ckSession&&(e({type:"PRIVY_OAUTH_RESPONSE",ckWebAuthToken:r.data.ckSession}),o()),"PRIVY_OAUTH_ERROR"===r.data.type&&(t(r.data.error),o()))}window.addEventListener("message",a)}))}async function y({api:e,provider:r,stateCode:t,codeVerifier:o,authorizationCode:a}){if(!a||!t)throw new n.PrivyClientError("[OAuth AuthFlow] Authorization and state codes code must be set prior to calling authenicate.");if("undefined"===a)throw new n.PrivyClientError("User denied confirmation during OAuth flow");try{return(await e.post(c.recoveryOAuthAuthenticatePath,{authorization_code:a,state_code:t,code_verifier:o,provider:r})).access_token}catch(e){let r=n.formatApiError(e);if(r.privyErrorCode)throw new n.PrivyClientError(r.message||"Invalid code during OAuth flow.",void 0,r.privyErrorCode);if("User denied confirmation during OAuth flow"===r.message)throw new n.PrivyClientError("Invalid code during oauth flow.",void 0,n.PrivyErrorCode.OAUTH_USER_DENIED);throw new n.PrivyClientError("Invalid code during OAuth flow.",void 0,n.PrivyErrorCode.UNKNOWN_AUTH_ERROR)}}async function h({api:e,provider:r}){let t=i.createCodeVerifier(),o=i.createStateCode(),a=await i.deriveCodeChallengeFromCodeVerifier(t);try{return"icloud"===r?{url:(await e.post(c.recoveryOAuthInitICloudPath,{client_type:"web"})).url}:{url:(await e.post(c.recoveryOAuthInitPath,{redirect_to:window.location.href,code_challenge:a,state_code:o})).url,codeVerifier:t,stateCode:o,provider:r}}catch(e){throw n.formatApiError(e)}}require("styled-components"),require("./useActiveWallet-vlXeDPzp.js"),require("zustand"),require("react-device-detect"),require("./prepareFundingModalData-DDf6xLze.js"),require("@privy-io/js-sdk-core"),require("eventemitter3"),require("viem"),require("viem/utils"),require("./getPublicClient-BsmZyCGX.js"),require("@heroicons/react/24/outline/ArrowLeftIcon"),require("@heroicons/react/24/outline/ArrowRightIcon"),require("@heroicons/react/24/outline/QuestionMarkCircleIcon"),require("@heroicons/react/24/outline/XMarkIcon"),require("tinycolor2"),require("uuid"),require("jose"),require("@coinbase/wallet-sdk"),require("@privy-io/ethereum"),require("mipd"),require("@privy-io/popup"),require("./usePrivy-Bx2PKTrU.js"),require("@scure/base"),require("@headlessui/react"),require("@walletconnect/ethereum-provider"),require("@privy-io/urls"),require("ofetch"),require("js-cookie"),require("./frame-Oz7volks.js"),require("@privy-io/routes"),require("x402/client"),require("@privy-io/api-base"),require("viem/accounts"),require("./use-sign-with-user-signer-Cu_6Bx7m.js"),require("./getEmbeddedConnectedWallet-6TsVZJkD.js");let p={"google-drive":{name:"Google Drive",component:u.GoogleDrive},icloud:{name:"iCloud",component:u.AppleICloud}};const w={component:()=>{let{logout:c}=l.usePrivyContext(),{navigate:w,setModalData:E,data:m}=l.usePrivyModal(),{closePrivyModal:C,createAnalyticsEvent:f}=n.usePrivyInternal(),{execute:A}=(()=>{let{client:e,walletProxy:r,refreshSessionAndUser:t}=n.usePrivyInternal(),{data:o}=l.usePrivyModal(),{user:a}=l.usePrivyContext(),c=d.useEmitPrivyEvent(),{create:u}=i.useCreateWalletWithoutFallback();return{execute:async({provider:i,action:d,popup:p,shouldCreateEth:w,shouldCreateSol:E})=>{let m,C;if(!e)throw new n.PrivyClientError("Missing client");function f(r){if(!r&&e)throw e.createAnalyticsEvent({eventName:"recovery_oauth_error",payload:{error:"Unable to open recovery OAuth popup",provider:i}}),new n.PrivyClientError("Recovery OAuth failed")}switch(i){case"google-drive":{let r,t,{url:o,codeVerifier:a,stateCode:l}=await h({api:e.api,provider:i});f(o);try{let a=await v({url:o,popup:p,provider:i});if(r=a.stateCode,t=a.authorizationCode,r!==l)throw e.createAnalyticsEvent({eventName:"possible_phishing_attempt",payload:{provider:i,storedStateCode:l??"",returnedStateCode:r??""}}),new n.PrivyClientError("Unexpected auth flow. This may be a phishing attempt.",void 0,n.PrivyErrorCode.OAUTH_UNEXPECTED)}catch(r){throw e.createAnalyticsEvent({eventName:"recovery_oauth_error",payload:{error:r.toString(),provider:i}}),new n.PrivyClientError("Recovery OAuth failed")}[m,C]=await Promise.all([e.getAccessToken(),y({api:e.api,provider:i,codeVerifier:a,stateCode:r,authorizationCode:t})]);break}case"icloud":{let{url:r}=await h({api:e.api,provider:i});f(r);let{ckWebAuthToken:t}=await v({url:r,popup:p,provider:i});C=t,m=await e.getAccessToken()}}if(!r)throw new n.PrivyClientError("Cannot connect to wallet proxy");if(!m)throw new n.PrivyClientError("Unable to authorize user");switch(d){case"recover":{let t=o?.recoverWallet?.entropyId,a=o?.recoverWallet?.entropyIdVerifier;if(!t||!a)throw new n.PrivyClientError("Recovery OAuth failed");e.createAnalyticsEvent({eventName:"embedded_wallet_recovery_started",payload:{walletAddress:t,recoveryMethod:i}}),await r.recover({accessToken:m,entropyId:t,entropyIdVerifier:a,recoveryAccessToken:C}),e.createAnalyticsEvent({eventName:"embedded_wallet_recovery_completed",payload:{walletAddress:t,recoveryMethod:i}});break}case"create-wallet":{let r;if(e.createAnalyticsEvent({eventName:"embedded_wallet_creation_started"}),w&&E)r=await u({recoveryMethod:i,recoveryAccessToken:C,chainType:"ethereum",walletIndex:0,latestUser:a}),r=await u({chainType:"solana",walletIndex:0,latestUser:r.user});else if(E)r=await u({recoveryMethod:i,recoveryAccessToken:C,chainType:"solana",walletIndex:0,latestUser:a});else{if(!w)throw Error("Invalid args to create wallet");r=await u({recoveryMethod:i,recoveryAccessToken:C,chainType:"ethereum",walletIndex:0,latestUser:a})}if(!r)throw c("createWallet","onError",n.PrivyErrorCode.UNKNOWN_EMBEDDED_WALLET_ERROR),Error("Failed to create wallet");e.createAnalyticsEvent({eventName:"embedded_wallet_creation_completed",payload:{walletAddress:r.account.address}}),c("createWallet","onSuccess",{wallet:r.account});break}case"set-recovery":{let o=l.getPrivyPrimaryWallet(a);if(!o)throw c("setWalletRecovery","onError",n.PrivyErrorCode.EMBEDDED_WALLET_NOT_FOUND),Error("Embedded wallet not found");e.createAnalyticsEvent({eventName:"embedded_wallet_set_recovery_started",payload:{walletAddress:o.address,existingRecoveryMethod:o.recoveryMethod,targetRecoveryMethod:i}});let{entropyId:d,entropyIdVerifier:u}=s.getEntropyDetailsForUser(a);await r.setRecovery({accessToken:m,entropyId:d,entropyIdVerifier:u,recoveryMethod:i,recoveryAccessToken:C});let v=l.getPrivyPrimaryWallet(await t());if(!v)throw c("createWallet","onError",n.PrivyErrorCode.UNKNOWN_EMBEDDED_WALLET_ERROR),Error("Failed to set recovery on wallet");e.createAnalyticsEvent({eventName:"embedded_wallet_set_recovery_completed",payload:{walletAddress:o.address,existingRecoveryMethod:o.recoveryMethod,targetRecoveryMethod:i}}),c("setWalletRecovery","onSuccess",{method:i,wallet:v});break}default:throw new n.PrivyClientError("Unsupported recovery action")}}}})(),[_,g]=r.useState(!1),{provider:P,action:q,isInAccountCreateFlow:R,shouldCreateEth:b,shouldCreateSol:S}=m?.recoveryOAuthStatus,[x,O]=r.useState(void 0),[k,T]=r.useState("create-wallet"===q);if("user-passcode"===P)throw Error("RecoveryOAuthScreen should never be called with a wallet that specifies recoveryMethod: `user-passcode`");let j=p[P].name,I=p[P].component,N=m?.recoverWallet?.onCompleteNavigateTo,U=new i.RunEffectOnce((async(e="create-wallet")=>(T(!0),new Promise(((r,t)=>{setTimeout((async()=>{try{let t=window.open();await A({provider:P,action:e,popup:t,shouldCreateEth:b,shouldCreateSol:S}),g(!0),r()}catch(r){O({message:`${"recover"===e?"Recovery":"Back up"} with ${j} unsuccessful`,detail:"recover"===q?`Please verify that you are selecting the ${j} account associated with your backup.`:"",retryable:!0}),t()}}),0)})))));r.useEffect((()=>{"recover"!==q&&U.execute(R?"create-wallet":"set-recovery")}),[]),r.useEffect((()=>{if(!_)return;let e=setTimeout((()=>{R?(E({createWallet:{onSuccess:()=>{},onFailure:e=>{f({eventName:"embedded_wallet_creation_failure_logout",payload:{error:e,screen:"RecoveryOAuthScreen"}}),c()},callAuthOnSuccessOnClose:!0,shouldCreateEth:!1,shouldCreateSol:!1}}),w("EmbeddedWalletCreatedScreen")):C({shouldCallAuthOnSuccess:!1})}),a.DEFAULT_SUCCESS_SCREEN_DURATION_MS);return()=>clearTimeout(e)}),[_]);let M=r.useCallback((async()=>{await U.execute("recover"),N?w(N):g(!0)}),[]),W="google-drive"===P?"Google Drive":"Apple iCloud",D=_&&`Successfully ${"recover"===q?"recovered":"backed up"} with ${W}.`||x&&x.message||`${"recover"===q?"Recovering":"Backing up"} with ${W}...`,F=x?x.detail:"";/*#__PURE__*/return e.jsxs(e.Fragment,{children:[/*#__PURE__*/e.jsx(t.ModalHeader,{}),k?/*#__PURE__*/e.jsx(e.Fragment,{children:/*#__PURE__*/e.jsxs(u.RecoveryContainer,{children:[/*#__PURE__*/e.jsx(o.CenteredScreenHeader,{title:D,icon:/*#__PURE__*/e.jsx(I,{style:{width:"38px",height:"38px"}}),description:F}),x&&x?.retryable?/*#__PURE__*/e.jsx(t.PrimaryButton,{onClick:()=>{i.stripUrlOAuthParamsAndRemoveStateCode(),O(void 0),"create-wallet"===q?U.execute("create-wallet"):M()},disabled:!_&&!x?.retryable,children:"Try again"}):null]})}):/*#__PURE__*/e.jsxs(u.RecoveryContainer,{children:[/*#__PURE__*/e.jsx(o.CenteredScreenHeader,{title:"Confirm it's really you",icon:/*#__PURE__*/e.jsx(I,{style:{height:42,width:48}}),description:`To confirm your identity, please log in to ${W} where your account is backed up.`}),/*#__PURE__*/e.jsxs(t.PrimaryButton,{onClick:M,children:["Confirm with ",W]})]}),/*#__PURE__*/e.jsx(t.BlobbyFooter,{})]})}};exports.RecoveryOAuthScreen=w,exports.default=w;
